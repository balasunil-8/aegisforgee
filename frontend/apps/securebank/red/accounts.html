<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Accounts - SecureBank | Red Team</title>
    <link rel="stylesheet" href="css/banking.css">
    <link rel="stylesheet" href="css/responsive.css">
    <link rel="stylesheet" href="css/components.css">
</head>
<body>
    <!-- Sidebar Navigation -->
    <nav class="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo">üè¶</div>
            <h2 class="sidebar-title">SecureBank</h2>
            <span class="version-badge-small">üî¥ RED</span>
        </div>
        
        <ul class="sidebar-menu">
            <li class="menu-item">
                <a href="dashboard.html">
                    <span class="menu-icon">üìä</span>
                    <span class="menu-text">Dashboard</span>
                </a>
            </li>
            <li class="menu-item active">
                <a href="accounts.html">
                    <span class="menu-icon">üí≥</span>
                    <span class="menu-text">Accounts</span>
                </a>
            </li>
            <li class="menu-item">
                <a href="transfer.html">
                    <span class="menu-icon">üí∏</span>
                    <span class="menu-text">Transfer</span>
                </a>
            </li>
            <li class="menu-item">
                <a href="transactions.html">
                    <span class="menu-icon">üìã</span>
                    <span class="menu-text">Transactions</span>
                </a>
            </li>
            <li class="menu-item">
                <a href="profile.html">
                    <span class="menu-icon">üë§</span>
                    <span class="menu-text">Profile</span>
                </a>
            </li>
            <li class="menu-item">
                <a href="settings.html">
                    <span class="menu-icon">‚öôÔ∏è</span>
                    <span class="menu-text">Settings</span>
                </a>
            </li>
        </ul>
        
        <div class="sidebar-footer">
            <button class="btn btn-danger btn-block" onclick="logout()">
                <span>üö™</span> Logout
            </button>
            <div style="margin-top: 16px; text-align: center;">
                <a href="../blue/accounts.html" style="color: var(--success-green); font-size: 0.85rem;">
                    üîµ Switch to Blue Team
                </a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Top Bar -->
        <header class="top-bar">
            <div class="top-bar-left">
                <button class="btn btn-icon mobile-menu-toggle" onclick="toggleSidebar()">‚ò∞</button>
                <h1 class="page-title">My Accounts</h1>
            </div>
            <div class="top-bar-right">
                <div class="user-info">
                    <span class="user-greeting" id="user-greeting">Loading...</span>
                    <div class="user-avatar">üë§</div>
                </div>
            </div>
        </header>

        <!-- Alert Container -->
        <div id="alert-container"></div>

        <!-- Vulnerability Warning -->
        <div class="alert alert-warning" style="margin: 20px;">
            <strong>‚ö†Ô∏è IDOR Vulnerability Demonstration</strong><br>
            This page is vulnerable to Insecure Direct Object Reference (IDOR). Account IDs are exposed in the URL 
            and not properly validated. Try changing the account ID parameter to access other users' accounts.
            <br><br>
            <strong>Try:</strong> <code>accounts.html?id=2001</code> or <code>accounts.html?id=2002</code>
        </div>

        <!-- Content -->
        <div class="content-wrapper">
            <!-- Account List View (when no ID specified) -->
            <div id="accounts-list-view" style="display: none;">
                <div class="section-header">
                    <h3>All Accounts</h3>
                    <button class="btn btn-primary" onclick="location.href='transfer.html'">
                        <span>üí∏</span> New Transfer
                    </button>
                </div>
                
                <div class="accounts-grid" id="accounts-grid">
                    <!-- Accounts will be loaded here -->
                </div>
            </div>

            <!-- Account Detail View (when ID specified) -->
            <div id="account-detail-view" style="display: none;">
                <div class="section-header">
                    <button class="btn btn-secondary" onclick="location.href='accounts.html'">
                        <span>‚Üê</span> Back to Accounts
                    </button>
                    <div>
                        <button class="btn btn-primary" onclick="initiateTransfer()">
                            <span>üí∏</span> Transfer Money
                        </button>
                    </div>
                </div>

                <div class="account-detail-card" id="account-detail">
                    <!-- Account details will be loaded here -->
                </div>

                <div class="account-detail-sections">
                    <div class="detail-section">
                        <h3>Account Information</h3>
                        <div class="info-grid" id="account-info">
                            <!-- Account info will be loaded here -->
                        </div>
                    </div>

                    <div class="detail-section">
                        <h3>Recent Activity</h3>
                        <div class="transactions-list" id="account-transactions">
                            <!-- Transactions will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay" style="display: none;">
        <div class="loading-spinner">
            <div class="spinner"></div>
            <p>Loading...</p>
        </div>
    </div>

    <script src="js/utils.js"></script>
    <script>
        // Ensure user is authenticated
        requireAuth();

        // Get current user
        const currentUser = getCurrentUser();
        document.getElementById('user-greeting').textContent = `Welcome, ${currentUser.name || currentUser.username}!`;

        // VULNERABILITY: IDOR - Insecure Direct Object Reference
        // Account IDs are exposed in URL and not properly validated
        // An attacker can modify the ID parameter to access other users' accounts
        
        // Sample accounts database (simulating all users' accounts)
        const allAccounts = [
            // Current user's accounts
            {
                id: 1001,
                userId: currentUser.id || 1,
                name: 'Primary Checking',
                type: 'checking',
                number: '****4532',
                fullNumber: '1234-5678-9012-4532',
                balance: 5420.50,
                currency: 'USD',
                status: 'active',
                openedDate: '2020-01-15',
                interestRate: 0.01
            },
            {
                id: 1002,
                userId: currentUser.id || 1,
                name: 'Savings Account',
                type: 'savings',
                number: '****8891',
                fullNumber: '1234-5678-9012-8891',
                balance: 12350.75,
                currency: 'USD',
                status: 'active',
                openedDate: '2020-01-15',
                interestRate: 2.5
            },
            // Other users' accounts (VULNERABLE - should not be accessible!)
            {
                id: 2001,
                userId: 2,
                name: 'John Doe Checking',
                type: 'checking',
                number: '****7723',
                fullNumber: '9876-5432-1098-7723',
                balance: 15000.00,
                currency: 'USD',
                status: 'active',
                openedDate: '2019-06-20',
                interestRate: 0.01
            },
            {
                id: 2002,
                userId: 3,
                name: 'Jane Smith Premium Savings',
                type: 'savings',
                number: '****3344',
                fullNumber: '5555-4444-3333-3344',
                balance: 50000.00,
                currency: 'USD',
                status: 'active',
                openedDate: '2018-03-10',
                interestRate: 3.5
            },
            {
                id: 2003,
                userId: 4,
                name: 'Bob Wilson Business Account',
                type: 'checking',
                number: '****9988',
                fullNumber: '7777-8888-9999-9988',
                balance: 125000.00,
                currency: 'USD',
                status: 'active',
                openedDate: '2017-11-05',
                interestRate: 0.5
            }
        ];

        // Sample transactions
        const accountTransactions = {
            1001: [
                { id: 't1', date: new Date().toISOString(), description: 'Coffee Shop', amount: -4.50, type: 'debit' },
                { id: 't2', date: new Date(Date.now() - 86400000).toISOString(), description: 'Grocery Store', amount: -67.82, type: 'debit' },
                { id: 't3', date: new Date(Date.now() - 172800000).toISOString(), description: 'Paycheck Deposit', amount: 2500.00, type: 'credit' }
            ],
            1002: [
                { id: 't4', date: new Date(Date.now() - 259200000).toISOString(), description: 'Interest Payment', amount: 25.50, type: 'credit' },
                { id: 't5', date: new Date(Date.now() - 2592000000).toISOString(), description: 'Transfer from Checking', amount: 1000.00, type: 'credit' }
            ],
            2001: [
                { id: 't6', date: new Date().toISOString(), description: 'Car Payment', amount: -450.00, type: 'debit' },
                { id: 't7', date: new Date(Date.now() - 86400000).toISOString(), description: 'Salary Direct Deposit', amount: 7500.00, type: 'credit' }
            ],
            2002: [
                { id: 't8', date: new Date().toISOString(), description: 'Investment Return', amount: 1200.00, type: 'credit' },
                { id: 't9', date: new Date(Date.now() - 172800000).toISOString(), description: 'Property Tax', amount: -5000.00, type: 'debit' }
            ],
            2003: [
                { id: 't10', date: new Date().toISOString(), description: 'Client Payment Received', amount: 15000.00, type: 'credit' },
                { id: 't11', date: new Date(Date.now() - 86400000).toISOString(), description: 'Vendor Payment', amount: -8500.00, type: 'debit' }
            ]
        };

        // Get account ID from URL
        function getAccountIdFromUrl() {
            const params = new URLSearchParams(window.location.search);
            return params.get('id') ? parseInt(params.get('id')) : null;
        }

        // VULNERABILITY: No authorization check! 
        // This function returns ANY account regardless of ownership
        function getAccount(accountId) {
            return allAccounts.find(acc => acc.id === accountId);
        }

        // Get user's accounts (for list view)
        function getUserAccounts() {
            return allAccounts.filter(acc => acc.userId === (currentUser.id || 1));
        }

        // Load accounts list
        function loadAccountsList() {
            const container = document.getElementById('accounts-grid');
            const userAccounts = getUserAccounts();
            
            container.innerHTML = userAccounts.map(account => `
                <div class="account-card large" onclick="viewAccount(${account.id})">
                    <div class="account-header">
                        <div class="account-icon large">${account.type === 'checking' ? 'üí≥' : 'üè¶'}</div>
                        <div class="account-info">
                            <h3 class="account-name">${account.name}</h3>
                            <p class="account-number">${account.number}</p>
                            <span class="badge badge-${account.status === 'active' ? 'success' : 'secondary'}">${account.status}</span>
                        </div>
                    </div>
                    <div class="account-balance large">
                        <p class="balance-label">Available Balance</p>
                        <h2 class="balance-amount">${formatCurrency(account.balance, account.currency)}</h2>
                        <p class="balance-detail">${account.type === 'savings' ? `${account.interestRate}% APY` : 'No minimum balance'}</p>
                    </div>
                </div>
            `).join('');
        }

        // Load account details
        function loadAccountDetail(accountId) {
            // VULNERABILITY: No ownership validation!
            // We're fetching account data without checking if it belongs to current user
            const account = getAccount(accountId);
            
            if (!account) {
                showAlert('Account not found', 'error');
                setTimeout(() => location.href = 'accounts.html', 2000);
                return;
            }

            // VULNERABILITY DEMONSTRATION: Show warning if accessing another user's account
            if (account.userId !== (currentUser.id || 1)) {
                showAlert('‚ö†Ô∏è IDOR VULNERABILITY EXPLOITED! You are viewing another user\'s account data!', 'error');
            }

            // Display account detail
            document.getElementById('account-detail').innerHTML = `
                <div class="account-header-large">
                    <div class="account-icon-large">${account.type === 'checking' ? 'üí≥' : 'üè¶'}</div>
                    <div>
                        <h2>${account.name}</h2>
                        <p class="account-number">${account.fullNumber}</p>
                        <span class="badge badge-${account.status === 'active' ? 'success' : 'secondary'}">${account.status}</span>
                    </div>
                </div>
                <div class="account-balance-large">
                    <p class="balance-label">Available Balance</p>
                    <h1 class="balance-amount">${formatCurrency(account.balance, account.currency)}</h1>
                </div>
            `;

            // Display account information
            document.getElementById('account-info').innerHTML = `
                <div class="info-item">
                    <label>Account Type</label>
                    <p>${account.type.charAt(0).toUpperCase() + account.type.slice(1)}</p>
                </div>
                <div class="info-item">
                    <label>Account Number</label>
                    <p>${account.fullNumber}</p>
                </div>
                <div class="info-item">
                    <label>Currency</label>
                    <p>${account.currency}</p>
                </div>
                <div class="info-item">
                    <label>Status</label>
                    <p><span class="badge badge-success">${account.status}</span></p>
                </div>
                <div class="info-item">
                    <label>Opened Date</label>
                    <p>${formatDate(account.openedDate)}</p>
                </div>
                <div class="info-item">
                    <label>Interest Rate</label>
                    <p>${account.interestRate}% APY</p>
                </div>
                <div class="info-item">
                    <label>Owner User ID</label>
                    <p>${account.userId} ${account.userId !== (currentUser.id || 1) ? '<span style="color: var(--danger-red);">‚ö†Ô∏è NOT YOUR ACCOUNT!</span>' : ''}</p>
                </div>
            `;

            // Load transactions for this account
            const transactions = accountTransactions[accountId] || [];
            if (transactions.length === 0) {
                document.getElementById('account-transactions').innerHTML = '<div class="empty-state">No transactions found</div>';
            } else {
                document.getElementById('account-transactions').innerHTML = transactions.map(tx => `
                    <div class="transaction-item">
                        <div class="transaction-icon ${tx.type}">${tx.type === 'credit' ? 'üì•' : 'üì§'}</div>
                        <div class="transaction-info">
                            <h4 class="transaction-description">${tx.description}</h4>
                            <p class="transaction-date">${formatDate(tx.date)}</p>
                        </div>
                        <div class="transaction-amount ${tx.amount > 0 ? 'positive' : 'negative'}">
                            ${tx.amount > 0 ? '+' : ''}${formatCurrency(tx.amount)}
                        </div>
                    </div>
                `).join('');
            }
        }

        // View account
        function viewAccount(accountId) {
            window.location.href = `accounts.html?id=${accountId}`;
        }

        // Initiate transfer from current account
        function initiateTransfer() {
            const accountId = getAccountIdFromUrl();
            window.location.href = `transfer.html?from=${accountId}`;
        }

        // Toggle sidebar
        function toggleSidebar() {
            document.querySelector('.sidebar').classList.toggle('active');
        }

        // Logout
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                clearSession();
                showAlert('Logged out successfully', 'success');
                setTimeout(() => window.location.href = 'login.html', 1000);
            }
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', () => {
            const accountId = getAccountIdFromUrl();
            
            if (accountId) {
                // Show account detail view
                document.getElementById('account-detail-view').style.display = 'block';
                loadAccountDetail(accountId);
            } else {
                // Show accounts list view
                document.getElementById('accounts-list-view').style.display = 'block';
                loadAccountsList();
            }
        });

        // Console warnings for Red Team
        console.log('%c‚ö†Ô∏è IDOR VULNERABILITY', 'background: #ff0000; color: white; padding: 10px; font-size: 14px; font-weight: bold;');
        console.log('Try accessing other accounts by changing the ID in the URL:');
        console.log('- accounts.html?id=2001 (John Doe - $15,000)');
        console.log('- accounts.html?id=2002 (Jane Smith - $50,000)');
        console.log('- accounts.html?id=2003 (Bob Wilson - $125,000)');
    </script>
</body>
</html>
